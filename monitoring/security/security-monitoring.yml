# Security Monitoring and Incident Response Configuration
# Comprehensive security monitoring for Reboot Media production environment

global:
  environment: production
  service: reboot-media-security
  retention_days: 90

# Security Data Sources
data_sources:
  # Application security logs
  - name: application_security
    type: elasticsearch
    index_pattern: "reboot-security-*"
    refresh_interval: "10s"
    
  # WAF logs (Web Application Firewall)
  - name: waf_logs
    type: elasticsearch
    index_pattern: "reboot-waf-*"
    refresh_interval: "30s"
    
  # Infrastructure security
  - name: infrastructure_security
    type: prometheus
    endpoint: "http://prometheus:9090"
    
  # Network security
  - name: network_monitoring
    type: suricata
    endpoint: "http://suricata-api:8080"

# Threat Detection Rules
threat_detection:
  # Authentication & Authorization Threats
  - name: brute_force_attack
    description: "Detect brute force authentication attempts"
    query: |
      sum(rate(auth_failed_attempts_total[5m])) by (source_ip) > 20
    severity: high
    threshold: 20
    time_window: "5m"
    actions:
      - block_ip_temporarily
      - notify_security_team
      - create_incident

  - name: credential_stuffing
    description: "Detect credential stuffing patterns"
    query: |
      count by (source_ip) (
        auth_failed_attempts_total{reason="invalid_credentials"}
      ) > 50
    severity: critical
    threshold: 50
    time_window: "10m"
    actions:
      - block_ip_permanently
      - notify_security_team
      - escalate_to_soc

  - name: privilege_escalation
    description: "Detect unauthorized privilege escalation attempts"
    query: |
      increase(authorization_failures_total{type="privilege_escalation"}[5m]) > 0
    severity: critical
    threshold: 1
    time_window: "5m"
    actions:
      - disable_user_account
      - notify_security_team
      - create_critical_incident

  # Injection Attack Detection
  - name: sql_injection_attempt
    description: "Detect SQL injection patterns in requests"
    lucene_query: |
      message: *("UNION SELECT" OR "OR 1=1" OR "'; DROP TABLE" OR "' OR '1'='1") 
      AND status_code: (200 OR 500)
    severity: high
    actions:
      - block_request
      - alert_development_team
      - log_detailed_request

  - name: xss_attempt
    description: "Detect Cross-Site Scripting attempts"
    lucene_query: |
      message: *("<script>" OR "javascript:" OR "onerror=" OR "onload=") 
      AND NOT user_agent: "legitimate-scanner"
    severity: medium
    actions:
      - sanitize_request
      - alert_development_team

  - name: command_injection
    description: "Detect command injection attempts"
    lucene_query: |
      message: *("; cat /etc/passwd" OR "; ls -la" OR "&& whoami" OR "| nc ")
    severity: high
    actions:
      - block_request
      - quarantine_session
      - create_incident

  # Data Exfiltration Detection
  - name: suspicious_data_access
    description: "Detect unusual data access patterns"
    query: |
      rate(database_queries_total{type="SELECT"}[5m]) > 1000
    severity: medium
    threshold: 1000
    time_window: "5m"
    actions:
      - throttle_requests
      - monitor_user_activity

  - name: large_data_export
    description: "Detect large data export attempts"
    query: |
      http_response_size_bytes > 100000000  # 100MB
    severity: medium
    threshold: 100000000
    actions:
      - log_detailed_access
      - verify_user_authorization

  # Application Security Threats
  - name: suspicious_file_upload
    description: "Detect potentially malicious file uploads"
    lucene_query: |
      path: "/api/upload" AND 
      (filename: "*.php" OR filename: "*.jsp" OR filename: "*.exe" OR filename: "*.sh")
    severity: high
    actions:
      - quarantine_file
      - scan_for_malware
      - alert_security_team

  - name: directory_traversal
    description: "Detect directory traversal attempts"
    lucene_query: |
      request_uri: *("../" OR "%2e%2e%2f" OR "..%5c")
    severity: medium
    actions:
      - block_request
      - log_security_event

  # Rate Limiting & DoS Protection
  - name: application_layer_ddos
    description: "Detect application layer DDoS attempts"
    query: |
      sum(rate(http_requests_total[1m])) by (source_ip) > 1000
    severity: high
    threshold: 1000
    time_window: "1m"
    actions:
      - enable_rate_limiting
      - activate_ddos_protection

  - name: slowloris_attack
    description: "Detect Slowloris-style attacks"
    query: |
      avg(http_request_duration_seconds) by (source_ip) > 30
    severity: medium
    threshold: 30
    actions:
      - limit_connection_timeout
      - monitor_connection_pool

# Security Incident Response Playbooks
incident_response:
  # Critical Security Incidents
  - name: data_breach_response
    triggers:
      - unauthorized_data_access
      - privilege_escalation
      - suspicious_data_export
    
    actions:
      immediate:
        - isolate_affected_systems
        - preserve_forensic_evidence
        - notify_security_team
        - activate_incident_commander
      
      short_term:
        - conduct_impact_assessment
        - notify_stakeholders
        - implement_containment_measures
        - document_incident_timeline
      
      long_term:
        - conduct_forensic_analysis
        - implement_remediation_plan
        - update_security_policies
        - conduct_post_incident_review

  - name: application_compromise
    triggers:
      - sql_injection_attempt
      - command_injection
      - suspicious_file_upload
    
    actions:
      immediate:
        - isolate_application
        - enable_waf_protection
        - notify_development_team
        - capture_traffic_samples
      
      short_term:
        - analyze_attack_vectors
        - patch_vulnerabilities
        - update_waf_rules
        - conduct_security_scan
      
      long_term:
        - implement_secure_coding_practices
        - enhance_input_validation
        - conduct_penetration_testing

  - name: ddos_attack_response
    triggers:
      - application_layer_ddos
      - network_layer_ddos
      - slowloris_attack
    
    actions:
      immediate:
        - activate_ddos_mitigation
        - scale_infrastructure
        - implement_rate_limiting
        - contact_isp_provider
      
      short_term:
        - analyze_attack_patterns
        - optimize_caching_strategy
        - implement_geo_blocking
        - monitor_attack_duration
      
      long_term:
        - review_ddos_preparedness
        - update_response_procedures
        - invest_in_ddos_protection

# Security Metrics and KPIs
security_metrics:
  - name: security_incidents_total
    description: "Total number of security incidents"
    query: "sum(increase(security_incidents_total[1h]))"
    target: 0
    critical_threshold: 5

  - name: mean_time_to_detect
    description: "Average time to detect security incidents"
    query: "avg(security_incident_detection_time_seconds)"
    target: 300  # 5 minutes
    critical_threshold: 1800  # 30 minutes

  - name: mean_time_to_respond
    description: "Average time to respond to security incidents"
    query: "avg(security_incident_response_time_seconds)"
    target: 900  # 15 minutes
    critical_threshold: 3600  # 1 hour

  - name: vulnerability_patch_time
    description: "Average time to patch vulnerabilities"
    query: "avg(vulnerability_patch_time_hours)"
    target: 24  # 24 hours
    critical_threshold: 168  # 7 days

  - name: false_positive_rate
    description: "Rate of false positive security alerts"
    query: "sum(rate(false_positive_alerts_total[1h])) / sum(rate(security_alerts_total[1h]))"
    target: 0.1  # 10%
    critical_threshold: 0.3  # 30%

# Compliance Monitoring
compliance:
  # PCI DSS Compliance (if processing payments)
  - framework: PCI_DSS
    version: "4.0"
    requirements:
      - name: "Access Control"
        controls:
          - multi_factor_authentication
          - role_based_access
          - session_management
      
      - name: "Data Protection"
        controls:
          - encryption_at_rest
          - encryption_in_transit
          - secure_key_management
      
      - name: "Monitoring"
        controls:
          - security_monitoring
          - audit_logging
          - intrusion_detection

  # GDPR Compliance
  - framework: GDPR
    requirements:
      - name: "Data Protection"
        controls:
          - data_encryption
          - access_controls
          - data_retention_policies
      
      - name: "Breach Notification"
        controls:
          - incident_detection
          - notification_procedures
          - documentation_requirements

  # SOC 2 Type II Compliance
  - framework: SOC2
    type: "Type II"
    trust_criteria:
      - security
      - availability
      - processing_integrity
      - confidentiality
      - privacy

# Security Dashboards Configuration
dashboards:
  - name: security_overview
    panels:
      - security_incidents_timeline
      - threat_detection_summary
      - compliance_status
      - security_metrics_kpi
  
  - name: threat_intelligence
    panels:
      - attack_patterns
      - threat_sources
      - vulnerability_trends
      - security_posture_score

  - name: incident_response
    panels:
      - active_incidents
      - response_metrics
      - escalation_status
      - remediation_progress

# Automated Response Actions
automated_responses:
  # IP Blocking
  - name: block_malicious_ip
    trigger: high_severity_threat
    action: |
      iptables -A INPUT -s ${source_ip} -j DROP
      echo "${source_ip} blocked at $(date)" >> /var/log/blocked_ips.log

  # User Account Suspension  
  - name: suspend_compromised_user
    trigger: credential_compromise
    action: |
      curl -X POST /api/v1/users/${user_id}/suspend \
        -H "Authorization: Bearer ${admin_token}" \
        -d '{"reason": "security_incident", "duration": "24h"}'

  # WAF Rule Update
  - name: update_waf_rules
    trigger: new_attack_pattern
    action: |
      curl -X POST /api/v1/waf/rules \
        -H "Content-Type: application/json" \
        -d '{"pattern": "${attack_pattern}", "action": "block"}'

# Integration Configuration
integrations:
  # SIEM Integration
  - name: splunk_integration
    type: siem
    endpoint: "https://splunk.rebootmedia.net:8088/services/collector"
    authentication: "Bearer ${SPLUNK_TOKEN}"
    
  # Threat Intelligence Feeds
  - name: threat_intelligence
    sources:
      - type: "commercial"
        provider: "ThreatConnect"
        api_endpoint: "https://api.threatconnect.com"
      
      - type: "open_source"
        provider: "MISP"
        api_endpoint: "https://misp.rebootmedia.net"
        
      - type: "government"
        provider: "US-CERT"
        feed_url: "https://us-cert.cisa.gov/ncas/alerts.xml"

  # Security Orchestration
  - name: security_orchestration
    platform: "Phantom"
    endpoint: "https://phantom.rebootmedia.net/rest"
    playbooks:
      - malware_response
      - data_breach_response
      - ddos_mitigation